<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yazma Testi — Profesyonel</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#1f2937;
  --primary:#60a5fa; --success:#9ca3af; --error:#ff6b6b; --glass: rgba(255,255,255,0.03);
  --bonus:#ffd700; /* Özel kelimeler için altın sarısı renk */
}
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; font-family:Inter,system-ui,Arial;
  background: linear-gradient(180deg,#071029 0%, #08101b 60%);
  color:#e6eef8; display:flex; align-items:flex-start; justify-content:center; padding:36px;
}
.container{width:100%;max-width:1100px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
h1{margin:0;font-size:20px;font-weight:600;color:#fff}
.top-controls{display:flex;gap:10px;align-items:center}
select, button, textarea, input{font-family:inherit}
.panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
label{font-size:13px;color:var(--muted);font-weight:600}
select{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:#e6eef8;padding:8px 10px;border-radius:8px}
textarea#customText{min-height:84px;width:420px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;resize:vertical}
.start-btn{background:linear-gradient(90deg,var(--primary),#3b82f6);border:0;padding:10px 14px;border-radius:10px;color:#06102a;font-weight:700;cursor:pointer}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
.test-area{display:flex;flex-direction:column;gap:12px}
#textContainer{background:#071226;padding:18px;border-radius:10px;min-height:140px;overflow:hidden;font-size:22px;line-height:2;color:#e6eef8}
.word-wrap{display:inline-block;white-space:nowrap;margin-right:10px}
.word-wrap.correct-word .char{color:var(--success)!important;opacity:0.8}
.word-wrap.wrong-word .char{color:var(--error)!important;opacity:1}
.word-wrap.bonus-word .char{color:var(--bonus)!important;font-weight:700}
.char{display:inline-block;padding:0 2px;transition:color .12s ease}
.char.current-char{background:linear-gradient(90deg,#e6eef8, #cbdaf0);color:#06102a;border-radius:6px;padding:0 6px;animation:blink 1s linear infinite}
.char.typed-correct{color:var(--success)}
.char.wrong-char{color:var(--error);font-weight:700}
@keyframes blink{0%,100%{opacity:0.95}50%{opacity:0.65}}
.input-row{display:flex;gap:12px;align-items:center;margin-top:6px}
#typed{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;font-size:16px}
.meta{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.meta-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.stat{min-width:110px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:600;text-align:center}
.stat strong{display:block;color:#e6eef8;font-size:18px}
.right{display:flex;flex-direction:column;gap:12px}
#results{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));min-height:120px}
.hint{font-size:13px;color:var(--muted)}
footer{margin-top:14px;color:var(--muted);font-size:13px}
.tabs {display:flex; gap:10px; margin-bottom:20px;}
.tabs button {background:var(--glass); border:1px solid rgba(255,255,255,0.04); color:#e6eef8; padding:8px 16px; border-radius:8px; cursor:pointer;}
.tabs button.active {background:linear-gradient(90deg,var(--primary),#3b82f6); color:#06102a;}
#raceCanvas {background:#333; border:1px solid #fff; border-radius:8px;}
#gameInput {width:400px; padding:10px; background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.04); border-radius:8px;}
#wordDisplay {font-size:24px; color:#fff; margin:10px 0; height:40px;}
#gameStatus {color:#fff; margin-top:10px; font-weight:700;}
.game-controls {display: flex; gap: 10px; margin-top: 10px;}
.game-controls input {flex: 1; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.04); background: var(--glass); color: #e6eef8;}
@media (max-width:980px){
  .grid{grid-template-columns:1fr;}
  textarea#customText{width:100%}
  .right{order:3}
}
</style>
</head>
<body>
<div class="container">
<header>
  <h1>Yazma Testi — Profesyonel</h1>
  <div class="top-controls">
    <div class="panel controls">
      <div>
        <label id="selectLabel" for="timeSelect">Süre</label><br>
        <select id="timeSelect">
          <option value="30">30 sn</option>
          <option value="60" selected>60 sn</option>
          <option value="120">120 sn</option>
        </select>
      </div>
      <div style="margin-left:6px">
        <label style="visibility:hidden">but</label><br>
        <button id="startBtn" class="start-btn">Teste Başla / Yeniden</button>
        <button id="startGameBtn" class="start-btn" style="display:none">Oyunu Başla</button>
      </div>
    </div>
  </div>
</header>

<div class="tabs">
  <button id="testTab" class="active">Yazma Testi</button>
  <button id="gameTab">Araba Oyunu</button>
</div>

<div id="testContent">
<div class="grid">
<div class="panel test-area">
  <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
    <div style="flex:1">
      <label for="customText" style="color:var(--muted);font-weight:600">Kendi metnin (opsiyonel)</label>
      <textarea id="customText" placeholder="İstersen buraya kendi metnini yaz. Boşsa rastgele kelimeler gelecek."></textarea>
    </div>
    <div style="min-width:220px">
      <div class="meta">
        <div style="font-weight:700;color:var(--muted)">Anlık İstatistik</div>
        <div class="meta-row" style="margin-top:8px">
          <div class="stat">Doğru<br><strong id="correctCount">0</strong></div>
          <div class="stat">Yanlış<br><strong id="wrongCount">0</strong></div>
          <div class="stat">Toplam<br><strong id="totalCount">0</strong></div>
        </div>
        <div class="meta-row" style="margin-top:8px">
          <div class="stat">WPM<br><strong id="wpm">0.00</strong></div>
          <div class="stat">DBV<br><strong id="dbv">0.00</strong></div>
          <div class="stat">Doğruluk<br><strong id="accuracy">0.00%</strong></div>
        </div>
        <div class="meta-row" style="margin-top:8px">
          <div class="stat">Bonus Puan<br><strong id="bonusPoints">0</strong></div>
        </div>
      </div>
    </div>
  </div>

  <div id="textContainer" aria-live="polite"></div>

  <div class="input-row">
    <input id="typed" placeholder="Yazmaya başla... (boşluk ile kelimeyi gönder)" autocomplete="off" autocapitalize="off" spellcheck="false" />
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
    <div class="hint">Boşluk/Enter ile kelime gönder. Hatalı harf anında kırmızı, gönderince yanlış/doğru sayılır. Altın kelimeler bonus puan kazandırır!</div>
    <div id="timer" style="font-weight:700">Süre: 0s</div>
  </div>
</div>

<div class="right">
  <div class="panel">
    <div style="font-weight:700;margin-bottom:8px">Sonuçlar</div>
    <div id="results">Teste başlayınca buraya sonuçlar gelecek.</div>
  </div>
  <div class="panel">
    <div style="font-weight:700;margin-bottom:8px">İpuçları</div>
    <div class="hint">1) Sesler için <code>click.mp3</code>, <code>error.mp3</code>, <code>bonus.mp3</code>, <code>win.mp3</code> ve <code>lose.mp3</code> dosyalarını aynı klasöre koy.<br>
    2) Tarayıcı ses izni için ilk etkileşim şart (ilk tuşla birlikte ses çalınır).<br>
    3) Yeniden başlatmak için "Teste Başla / Yeniden" butonuna veya F5'e bas.<br>
    4) Altın kelimeleri doğru yaz, bonus puan kazan!</div>
  </div>
</div>
</div>
</div>

<div id="gameContent" style="display:none">
  <div class="panel">
    <canvas id="raceCanvas" width="800" height="400"></canvas>
    <div id="wordDisplay" style="font-size:24px; color:#fff; margin:10px 0; height:40px;"></div>
    <input id="gameInput" placeholder="Yazmaya başla..." autocomplete="off" autocapitalize="off" spellcheck="false">
    <div class="game-controls">
      <input type="number" id="speedInput" min="1" max="240" value="5" placeholder="Rakip hızı (1-240)">
      <button id="setSpeedBtn" class="start-btn">Hızı Ayarla</button>
    </div>
    <div id="gameStatus" style="color:#fff; margin-top:10px; font-weight:700;"></div>
  </div>
</div>

<footer>Made with ❤️ — Test tamamen lokal çalışır</footer>
</div>

<!-- Ses elementleri -->
<audio id="clickSound" src="click.mp3" preload="auto"></audio>
<audio id="errorSound" src="error.mp3" preload="auto"></audio>
<audio id="bonusSound" src="bonus.mp3" preload="auto"></audio>
<audio id="winSound" src="win.mp3" preload="auto"></audio>
<audio id="loseSound" src="lose.mp3" preload="auto"></audio>

<script>
const clickSound = document.getElementById('clickSound');
const errorSound = document.getElementById('errorSound');
const bonusSound = document.getElementById('bonusSound');
const winSound = document.getElementById('winSound');
const loseSound = document.getElementById('loseSound');
const timeSelect = document.getElementById('timeSelect');
const selectLabel = document.getElementById('selectLabel');
const startBtn = document.getElementById('startBtn');
const startGameBtn = document.getElementById('startGameBtn');
const customText = document.getElementById('customText');
const textContainer = document.getElementById('textContainer');
const typedInput = document.getElementById('typed');
const timerEl = document.getElementById('timer');
const resultsEl = document.getElementById('results');
const correctCountEl = document.getElementById('correctCount');
const wrongCountEl = document.getElementById('wrongCount');
const totalCountEl = document.getElementById('totalCount');
const wpmEl = document.getElementById('wpm');
const dbvEl = document.getElementById('dbv');
const accEl = document.getElementById('accuracy');
const bonusPointsEl = document.getElementById('bonusPoints');

let generatedWords = [
  {text: "ali", isBonus: false}, {text: "ayşe", isBonus: false}, {text: "fatma", isBonus: false}, {text: "top", isBonus: false}, {text: "koşuyor", isBonus: true},
  {text: "okul", isBonus: false}, {text: "kitap", isBonus: false}, {text: "bahçe", isBonus: false}, {text: "masa", isBonus: false}, {text: "sandalye", isBonus: false},
  {text: "araba", isBonus: false}, {text: "elma", isBonus: false}, {text: "armut", isBonus: false}, {text: "çocuk", isBonus: false}, {text: "köpek", isBonus: false},
  {text: "kedi", isBonus: false}, {text: "ev", isBonus: false}, {text: "bahar", isBonus: false}, {text: "güneş", isBonus: false}, {text: "yağmur", isBonus: false},
  {text: "yemek", isBonus: false}, {text: "oyun", isBonus: false}, {text: "arkadaş", isBonus: false}, {text: "şehir", isBonus: false}, {text: "yaz", isBonus: false},
  {text: "kış", isBonus: false}, {text: "park", isBonus: false}, {text: "bisiklet", isBonus: false}, {text: "telefon", isBonus: false}, {text: "bilgisayar", isBonus: true}
];

let testWords = [], currentIndex = 0, started = false, timerInterval = null, startTime = null, duration = 60;
let correctWords = 0, wrongWords = 0, totalTypedWords = 0, keyPressCount = 0, bonusPoints = 0;
let countdownPlayed = []; // Geri sayım seslerinin çalındığını takip etmek için

function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
function getRandomWord(prev) {
  let w;
  const isBonusChance = Math.random() < 0.1;
  const candidates = isBonusChance ? generatedWords.filter(w => w.isBonus) : generatedWords.filter(w => !w.isBonus);
  do { w = candidates[Math.floor(Math.random() * candidates.length)]; } while (w.text === prev);
  return w;
}

function buildTestWords() {
  testWords = [];
  const user = customText.value.trim();
  if (user) {
    user.split(/\s+/).filter(s => s.trim() !== "").forEach(w => testWords.push({ text: w, status: "", isBonus: false }));
  } else {
    let prev = "";
    for (let i = 0; i < 400; i++) {
      const w = getRandomWord(prev);
      testWords.push({ text: w.text, status: "", isBonus: w.isBonus });
      prev = w.text;
    }
  }
}

function renderWindow() {
  textContainer.innerHTML = "";
  const windowSize = 12;
  for (let i = currentIndex; i < Math.min(currentIndex + windowSize, testWords.length); i++) {
    const pw = testWords[i];
    const wspan = document.createElement('span');
    wspan.className = 'word-wrap';
    if (pw.status === 'correct') wspan.classList.add('correct-word');
    if (pw.status === 'wrong') wspan.classList.add('wrong-word');
    if (pw.isBonus && pw.status === '') wspan.classList.add('bonus-word');
    wspan.dataset.index = i;
    for (const ch of pw.text) {
      const c = document.createElement('span'); c.className = 'char'; c.innerText = ch; wspan.appendChild(c);
    }
    wspan.appendChild(document.createTextNode(" "));
    textContainer.appendChild(wspan);
  }
  highlightCurrentChar();
}

function highlightCurrentChar() {
  const firstSpan = textContainer.querySelector('.word-wrap'); if (!firstSpan) return;
  const charSpans = Array.from(firstSpan.querySelectorAll('.char'));
  const typed = typedInput.value; const target = testWords[currentIndex]?.text || "";
  charSpans.forEach(ch => { ch.classList.remove('current-char', 'typed-correct', 'wrong-char'); });
  let idxToHighlight = 0;
  for (let i = 0; i < Math.min(typed.length, charSpans.length); i++) {
    const t = typed[i]; const g = target[i];
    if (t !== g) {
      charSpans[i].classList.add('wrong-char');
      try { errorSound.currentTime = 0; errorSound.play(); } catch (e) {}
      break;
    } else if (t === g) {
      charSpans[i].classList.add('typed-correct');
      try { clickSound.currentTime = 0; clickSound.play(); } catch (e) {}
    }
    idxToHighlight = i + 1;
  }
  if (idxToHighlight < charSpans.length) charSpans[idxToHighlight].classList.add('current-char');
}

function submitCurrentWord() {
  const typed = typedInput.value.trim();
  const target = testWords[currentIndex]?.text;
  totalTypedWords++;
  if (typed === target) {
    testWords[currentIndex].status = 'correct';
    correctWords++;
    if (testWords[currentIndex].isBonus) {
      bonusPoints += 10;
      try { bonusSound.currentTime = 0; bonusSound.play(); } catch (e) {}
    }
  } else {
    testWords[currentIndex].status = 'wrong';
    wrongWords++;
    try { errorSound.currentTime = 0; errorSound.play(); } catch (e) {}
  }
  currentIndex++;
  typedInput.value = "";
  renderWindow();
  updateLiveStats();
  if (currentIndex >= testWords.length) finishTest();
}

function startTimerIfNeeded() {
  if (started) return;
  started = true;
  duration = parseInt(timeSelect.value, 10) || 60;
  startTime = Date.now();
  countdownPlayed = []; // Geri sayım seslerini sıfırla
  timerEl.innerText = `Süre: ${duration}s`;
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const remaining = Math.max(0, duration - elapsed);
    timerEl.innerText = `Süre: ${remaining}s`;
    
    // Son 10 saniyede geri sayım sesi çal
    if (remaining <= 10 && remaining > 0) {
      playCountdownSound(remaining);
    }
    
    if (remaining <= 0) finishTest();
  }, 250);
}

// Geri sayım sesi çalma fonksiyonu (Kod ile üretilecek)
function playCountdownSound(secondsLeft) {
  // Aynı saniye için birden fazla ses çalınmasını önle
  if (countdownPlayed.includes(secondsLeft)) return;
  
  countdownPlayed.push(secondsLeft);
  
  // Web Audio API ile ses üret (MP3 dosyası gerekmez)
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Saniyeye göre farklı frekanslar
    if (secondsLeft === 10) oscillator.frequency.value = 600;
    else if (secondsLeft === 9) oscillator.frequency.value = 650;
    else if (secondsLeft === 8) oscillator.frequency.value = 700;
    else if (secondsLeft === 7) oscillator.frequency.value = 750;
    else if (secondsLeft === 6) oscillator.frequency.value = 800;
    else if (secondsLeft === 5) oscillator.frequency.value = 850;
    else if (secondsLeft === 4) oscillator.frequency.value = 900;
    else if (secondsLeft === 3) oscillator.frequency.value = 950;
    else if (secondsLeft === 2) oscillator.frequency.value = 1000;
    else if (secondsLeft === 1) oscillator.frequency.value = 1200;
    
    oscillator.type = 'sine';
    gainNode.gain.value = 0.3;
    
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.3);
    
    setTimeout(() => {
      oscillator.stop();
    }, 300);
  } catch (e) {
    console.error('Ses çalma hatası:', e);
  }
}

function finishTest() {
  if (timerInterval) clearInterval(timerInterval);
  typedInput.disabled = true;
  const total = correctWords + wrongWords;
  const elapsedMinutes = Math.max((Date.now() - startTime) / 1000 / 60, 1 / 60);
  const wpm = (correctWords / elapsedMinutes) || 0;
  const dbv = (keyPressCount / elapsedMinutes) || 0;
  const acc = total > 0 ? (correctWords / total * 100) : 0;
  resultsEl.innerHTML = `
    <div style="font-weight:700">Test Tamamlandı</div>
    <div style="margin-top:8px">
      Toplam Kelime: ${total}<br>
      Doğru Kelime: ${correctWords}<br>
      Yanlış Kelime: ${wrongWords}<br>
      Doğruluk: ${acc.toFixed(2)}%<br>
      WPM (Doğru/dk): ${wpm.toFixed(2)}<br>
      DBV (Tuş basışı/dk): ${dbv.toFixed(2)}<br>
      Bonus Puan: ${bonusPoints}
    </div>
    <div style="color:#ff7b7b;font-weight:700;margin-top:10px">Yeniden başlatmak için "Teste Başla / Yeniden" butonuna tıkla veya F5'e bas.</div>
  `;
  updateLiveStats();
}

function updateLiveStats() {
  correctCountEl.innerText = correctWords;
  wrongCountEl.innerText = wrongWords;
  totalCountEl.innerText = correctWords + wrongWords;
  bonusPointsEl.innerText = bonusPoints;
  const elapsedMs = started && startTime ? Math.min(duration * 1000, Date.now() - startTime) : 0;
  const elapsedMinutes = Math.max((elapsedMs / 1000) / 60, 1 / 60);
  wpmEl.innerText = ((correctWords / elapsedMinutes) || 0).toFixed(2);
  dbvEl.innerText = ((keyPressCount / elapsedMinutes) || 0).toFixed(2);
  
  const totalWords = correctWords + wrongWords;
  accEl.innerText = (totalWords > 0 ? ((correctWords / totalWords) * 100).toFixed(2) : '0.00') + '%';
}

// Sekme Switching
const testTab = document.getElementById('testTab');
const gameTab = document.getElementById('gameTab');
const testContent = document.getElementById('testContent');
const gameContent = document.getElementById('gameContent');

function switchToTest() {
  testTab.classList.add('active');
  gameTab.classList.remove('active');
  testContent.style.display = 'block';
  gameContent.style.display = 'none';
  selectLabel.innerText = 'Süre';
  timeSelect.innerHTML = `
    <option value="30">30 sn</option>
    <option value="60" selected>60 sn</option>
    <option value="120">120 sn</option>
  `;
  startBtn.style.display = 'inline-block';
  startGameBtn.style.display = 'none';
  timerEl.innerText = `Süre: ${timeSelect.value}s`;
}

function switchToGame() {
  gameTab.classList.add('active');
  testTab.classList.remove('active');
  testContent.style.display = 'none';
  gameContent.style.display = 'block';
  selectLabel.innerText = 'Rakip Hızı';
  
  // Zorluk seviyelerini 1-240 arasında değerlerle güncelle
  timeSelect.innerHTML = '';
  for (let i = 1; i <= 240; i += 30) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    if (i === 30) option.selected = true;
    timeSelect.appendChild(option);
  }
  
  startBtn.style.display = 'none';
  startGameBtn.style.display = 'inline-block';
  timerEl.innerText = `Rakip Hızı: ${timeSelect.value}`;
}

testTab.addEventListener('click', switchToTest);
gameTab.addEventListener('click', switchToGame);

// Yazma Testi
startBtn.addEventListener('click', () => {
  if (timerInterval) clearInterval(timerInterval);
  currentIndex = 0; started = false; startTime = null; correctWords = 0; wrongWords = 0; totalTypedWords = 0; keyPressCount = 0; bonusPoints = 0;
  resultsEl.innerHTML = "Teste başladığında sonuç burada gözükecek.";
  typedInput.disabled = false; typedInput.value = "";
  buildTestWords(); renderWindow();
  timerEl.innerText = `Süre: ${timeSelect.value}s`; updateLiveStats(); typedInput.focus();
});

typedInput.addEventListener('keydown', (e) => {
  if (!started && e.key.length === 1) startTimerIfNeeded();
  if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
    keyPressCount++;
    try { clickSound.currentTime = 0; clickSound.play(); } catch (err) {}
  }
  if (e.key === ' ' || e.key === 'Enter') {
    e.preventDefault();
    submitCurrentWord();
  }
});

typedInput.addEventListener('input', () => { highlightCurrentChar(); updateLiveStats(); });
window.addEventListener('load', () => {
  buildTestWords(); renderWindow(); timerEl.innerText = `Süre: ${timeSelect.value}s`; typedInput.focus();
});

// Araba Oyunu
const raceCanvas = document.getElementById('raceCanvas');
const ctx = raceCanvas.getContext('2d');
const wordDisplay = document.getElementById('wordDisplay');
const gameInput = document.getElementById('gameInput');
const gameStatus = document.getElementById('gameStatus');
const speedInput = document.getElementById('speedInput');
const setSpeedBtn = document.getElementById('setSpeedBtn');

let playerPosition = 0;
let opponentPosition = 0;
let finishLine = raceCanvas.width - 100;
let opponentSpeed = 1;
let currentWord = '';
let currentCharIndex = 0;
let gameRunning = false;
let gameStarted = false;

// Araba görselleri
const playerCarImg = new Image();
playerCarImg.src = 'playerCar.png';
const opponentCarImg = new Image();
opponentCarImg.src = 'opponentCar.png';

// Varsayılan araba çizimi (görseller yüklenmezse kullanılacak)
function drawDefaultPlayerCar(x, y) {
  ctx.fillStyle = '#3498db';
  ctx.fillRect(x, y, 80, 40);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(x + 10, y + 10, 20, 15);
  ctx.fillRect(x + 50, y + 10, 20, 15);
  ctx.fillStyle = '#000000';
  ctx.fillRect(x + 10, y + 35, 15, 8);
  ctx.fillRect(x + 55, y + 35, 15, 8);
}

function drawDefaultOpponentCar(x, y) {
  ctx.fillStyle = '#e74c3c';
  ctx.fillRect(x, y, 80, 40);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(x + 10, y + 10, 20, 15);
  ctx.fillRect(x + 50, y + 10, 20, 15);
  ctx.fillStyle = '#000000';
  ctx.fillRect(x + 10, y + 35, 15, 8);
  ctx.fillRect(x + 55, y + 35, 15, 8);
}

function selectNewWord() {
  const wordObj = generatedWords[Math.floor(Math.random() * generatedWords.length)];
  currentWord = wordObj.text;
  wordDisplay.innerText = currentWord;
  currentCharIndex = 0;
  gameInput.value = '';
  gameInput.style.color = '#fff';
}

function gameLoop() {
  if (!gameRunning) return;

  ctx.clearRect(0, 0, raceCanvas.width, raceCanvas.height);

  // Yol
  ctx.fillStyle = '#2c3e50';
  ctx.fillRect(0, 100, raceCanvas.width, 200);

  // Yol çizgileri
  ctx.fillStyle = '#ffffff';
  for (let i = 0; i < raceCanvas.width; i += 40) {
    ctx.fillRect(i, 200, 20, 10);
  }

  // Bitiş çizgisi
  ctx.fillStyle = '#f1c40f';
  for (let i = 0; i < 20; i++) {
    if (i % 2 === 0) {
      ctx.fillRect(finishLine, 100 + i * 10, 10, 10);
    }
  }

  // Kullanıcı arabası (alt şerit)
  if (playerCarImg.complete) {
    ctx.drawImage(playerCarImg, playerPosition, 250, 80, 40);
  } else {
    drawDefaultPlayerCar(playerPosition, 250);
  }

  // Rakip araba (üst şerit)
  if (opponentCarImg.complete) {
    ctx.drawImage(opponentCarImg, opponentPosition, 150, 80, 40);
  } else {
    drawDefaultOpponentCar(opponentPosition, 150);
  }

  // Rakibin hızını ayarla
  opponentPosition += opponentSpeed;

  if (opponentPosition >= finishLine) {
    gameStatus.innerText = 'Rakip kazandı!';
    gameRunning = false;
    try { loseSound.currentTime = 0; loseSound.play(); } catch (e) {}
    return;
  }
  if (playerPosition >= finishLine) {
    gameStatus.innerText = 'Sen kazandın!';
    gameRunning = false;
    try { winSound.currentTime = 0; winSound.play(); } catch (e) {}
    return;
  }

  requestAnimationFrame(gameLoop);
}

// Oyunu başlatma fonksiyonu
function startGame() {
  playerPosition = 0;
  opponentPosition = 0;
  opponentSpeed = parseInt(speedInput.value, 10) / 20; // Çok daha yavaş hız
  gameRunning = true;
  gameStarted = true;
  selectNewWord();
  gameStatus.innerText = '';
  gameInput.focus();
  
  if (playerCarImg.complete && opponentCarImg.complete) {
    gameLoop();
  }
}

startGameBtn.addEventListener('click', () => {
  startGame();
});

setSpeedBtn.addEventListener('click', () => {
  opponentSpeed = parseInt(speedInput.value, 10) / 20; // Çok daha yavaş hız
  timerEl.innerText = `Rakip Hızı: ${speedInput.value}`;
});

// OTOMATİK BAŞLATMA - Yazmaya başlayınca oyun otomatik başlasın
gameInput.addEventListener('input', () => {
  // Oyun daha başlamadıysa ve yazmaya başlandıysa otomatik başlat
  if (!gameStarted && gameInput.value.length > 0) {
    startGame();
  }
  
  const typed = gameInput.value.toLowerCase();
  if (typed.length > currentCharIndex) {
    const char = typed.charAt(currentCharIndex);
    if (char === currentWord.toLowerCase().charAt(currentCharIndex)) {
      currentCharIndex++;
      playerPosition += 10; // Daha dengeli ilerleme
      gameInput.style.color = '#fff';
      try { clickSound.currentTime = 0; clickSound.play(); } catch (e) {}
      if (currentCharIndex === currentWord.length) {
        selectNewWord();
      }
    } else {
      gameInput.value = typed.substring(0, currentCharIndex);
      gameInput.style.color = '#ff6b6b';
      try { errorSound.currentTime = 0; errorSound.play(); } catch (e) {}
    }
  }
});

// Oyun sekmesine geçince input'a odaklan
gameTab.addEventListener('click', () => {
  setTimeout(() => {
    gameInput.focus();
  }, 100);
});
</script>
</body>
</html>